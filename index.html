<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Parking System</title>
  <style>
    :root {
      --bg: #18181b;
      --card-bg: #27272a;
      --text: #f4f4f5;
      --border: #3f3f46;
      --primary: #d4d4d8;
      --primary-hover: #a1a1aa;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 1rem;
    }

    #app {
      width: 100%;
      max-width: 400px;
    }

    #form {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1.5rem;
      text-align: center;
    }
    #form h2 {
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }
    #form input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      background: var(--bg);
      color: var(--text);
    }
    #form button {
      width: 100%;
      padding: 0.75rem;
      border: none;
      border-radius: 0.375rem;
      background: var(--primary);
      color: var(--bg);
      cursor: pointer;
      transition: background 0.2s;
    }
    #form button:hover {
      background: var(--primary-hover);
    }

    #result {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1.5rem;
      white-space: pre-wrap;
      margin-top: 1rem;
      display: none;
    }

    p {
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="form">
      <h2>Smart Parking System</h2>
      <form>
        <input type="text" id="otp" placeholder="Enter OTP" required>
        <button type="submit">Get Parking Slot</button>
      </form>
    </div>
    <div id="result"></div>
  </div>

  <script>
    const SESSION_URL = 'http://192.168.12.1:4242/api/sessions/me'

    const showForm = () => {
      document.getElementById('form').style.display = 'block'
      document.getElementById('result').style.display = 'none'
    }

    const hideForm = () => {
      document.getElementById('form').style.display = 'none'
      document.getElementById('result').style.display = 'block'
    }

    const displayResult = (data) => {
      const s = data.data.session; const t = data.data.slot
      let html = `<h2>Parking Session Details</h2>
<span><strong><em>Slot:</em></strong> ${t?.location ?? '-'}</span>
<span><strong><em>Vehicle:</em></strong> ${s.vehicle}</span>
<span><strong><em>Entry:</em></strong> ${new Date(s.entry_at).toLocaleString()}</span>
<span><strong><em>Parked:</em></strong> ${s.parked_at && new Date(s.parked_at).toLocaleString() || '-'}</span>
<span><strong><em>Left:</em></strong> ${s.left_at && new Date(s.left_at).toLocaleString() || '-'}</span>
<span><strong><em>Amount:</em></strong> ${s.amount_paid ?? '-'}</span>`
      document.getElementById('result').innerHTML = html
    }

    const fetchSession = async (otp = null, token = null) => {
      const endpoint = SESSION_URL
      const method = (token && !otp) ? 'GET' : 'POST'
      let headers = { 'Content-Type': 'application/json' }
      if (token) headers['Authorization'] = 'session ' + token
      const payload = otp ? { symbol: otp } : undefined

      try {
        const response = await fetch(endpoint, {
          method, headers,
          body: payload && JSON.stringify(payload)
        })

        if (response.status === 401) {
          localStorage.removeItem('token'); showForm()
          throw new Error('Please enter your OTP.')
        }

        const data = await response.json()
        if (data.error) throw new Error(data.error.message)
        if ((!otp && token) || (data.data && data.data.token)) {
          if(data.data.token) localStorage.setItem('token', data.data.token)
        }

        if (!data) return
        hideForm(); displayResult(data)
      } catch (error) {
        console.error(error)
        alert(error.message)
      }      
    }

    document.getElementById('form').addEventListener('submit', (e) => {
      e.preventDefault();
      let otp = document.getElementById('otp').value.trim();
      if (!otp) return alert('Please enter an OTP.')

      fetchSession(otp, null);
    })

    window.onload = () => {
      const token = localStorage.getItem('token')
      token ? fetchSession(null, token) : showForm()
    }
  </script>
</body>
</html>
