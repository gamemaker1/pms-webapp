<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Parking System</title>
  <style>
    :root {
      --bg: #18181b;           /* Dark background */
      --card-bg: #27272a;       /* Dark card background */
      --text: #f4f4f5;          /* Light text */
      --border: #3f3f46;        /* Dark border */
      --primary: #d4d4d8;       /* New primary light color */
      --primary-hover: #a1a1aa; /* Darker tone for hover */
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 1rem;
    }
    #app {
      width: 100%;
      max-width: 400px;
    }
    /* Centered card style for the OTP form */
    #otpForm {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1.5rem;
      text-align: center;
    }
    #otpForm h2 {
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }
    #otpForm input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      background: var(--bg);
      color: var(--text);
    }
    #otpForm button {
      width: 100%;
      padding: 0.75rem;
      border: none;
      border-radius: 0.375rem;
      background: var(--primary);
      color: var(--bg);
      cursor: pointer;
      transition: background 0.2s;
    }
    #otpForm button:hover {
      background: var(--primary-hover);
    }
    /* Result card â€“ hidden by default */
    #result {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1.5rem;
      white-space: pre-wrap;
      margin-top: 1rem;
      display: none;
    }
    /* Reduce spacing for paragraphs */
    p {
      margin: 0.5rem 0;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- OTP Form -->
    <div id="otpForm">
      <h2>Enter OTP</h2>
      <form id="form">
        <input type="text" id="otp" placeholder="Enter OTP" required>
        <button type="submit">Submit</button>
      </form>
    </div>
    <!-- Result container -->
    <div id="result"></div>
  </div>

  <script>
    // API endpoints
    const REQUEST_URL = 'http://192.168.12.1:4242/api/slots/request';
    const SESSION_URL = 'http://192.168.12.1:4242/api/session';

    // Show form and hide result
    function showForm() {
      document.getElementById('otpForm').style.display = 'block';
      document.getElementById('result').style.display = 'none';
    }
    // Hide form and show result
    function hideForm() {
      document.getElementById('otpForm').style.display = 'none';
      document.getElementById('result').style.display = 'block';
    }
    // Render session and slot information, excluding some fields
    function displayResult(data) {
      const s = data.data.session;
      const t = data.data.slot;
      let html = `<h2>Parking Session Details</h2>
<span><strong>Symbol:</strong> ${s.symbol}</span>
<span><strong>Vehicle:</strong> ${s.vehicle}</span>
<span><strong>Location:</strong> ${t.location}</span>
<span><strong>Type:</strong> ${t.type}</span>
<span><strong>Entry:</strong> ${new Date(s.entry_at).toLocaleString()}</span>
<span><strong>Parked:</strong> ${s.parked_at && new Date(s.parked_at).toLocaleString() || '-'}</span>
<span><strong>Left:</strong> ${s.left_at && new Date(s.left_at).toLocaleString() || '-'}</span>
<span><strong>Amount:</strong> ${s.amount_paid || '-'}</span>`
      document.getElementById('result').innerHTML = html;
    }
    // API call logic
    function callAPI(otp = null, token = null) {
      const endpoint = (token && !otp) ? SESSION_URL : REQUEST_URL;
      const method = (token && !otp) ? 'GET' : 'POST';
      let headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = 'session ' + token;
      const payload = otp ? { symbol: otp } : undefined;
      fetch(endpoint, {
        method,
        headers,
        body: payload && JSON.stringify(payload)
      })
      .then(async response => {
        if (response.status === 401) {
          localStorage.removeItem('token');
          showForm();
          throw new Error('Unauthorized: Token expired or invalid. Enter OTP again.');
        }
        let data = await response.json();
        if (data.error) { alert(data.error.message); return; }
        if ((!otp && token) || (data.data && data.data.token)) {
          if(data.data.token) localStorage.setItem('token', data.data.token);
        }
        return data;
      })
      .then(data => {
        if (!data) return;
        hideForm();
        displayResult(data);
      })
      .catch(error => { console.error('Error:', error); alert(error.message); });
    }
    // Handle OTP form submission
    document.getElementById('form').addEventListener('submit', function(e) {
      e.preventDefault();
      let otp = document.getElementById('otp').value.trim();
      if (!otp) { alert('Please enter an OTP'); return; }
      callAPI(otp, null);
    });
    // On load, use stored token if available
    window.onload = function() {
      const token = localStorage.getItem('token');
      token ? callAPI(null, token) : showForm();
    }
  </script>
</body>
</html>
